# Summary for include/fwa_capi.h

This header file defines the C Application Programming Interface (C-API) for the FireWire Audio (FWA) library. This API allows applications written in C, or other languages that can interface with C (like Swift, Python, etc.), to utilize the functionalities of the underlying C++ FWA library.

**Key Components and Functionalities:**

1.  **Standard C Includes:**
    -   Includes `<stddef.h>`, `<stdint.h>`, `<stdbool.h>` for standard C types.
    -   Includes `<mach/kern_return.h>` and `<IOKit/IOReturn.h>` for IOKit status/error codes, which are used as return types for many API functions.

2.  **`extern "C"` Guards:**
    -   `#ifdef __cplusplus extern "C" { ... } #endif`: Ensures that the function names declared in this header have C linkage, preventing C++ name mangling and allowing them to be correctly linked by C compilers or other language runtimes.

3.  **Opaque Types (Handles):**
    -   `typedef struct FWAEngine* FWAEngineRef;`: Defines `FWAEngineRef` as an opaque pointer. Clients interact with an "engine" instance (representing the FWA library's core) through this handle, without needing to know the internal C++ class structure (`FWA::DeviceController` or a similar top-level manager).
    -   `typedef struct FWADevice* FWADeviceRef;`: Defines `FWADeviceRef` as an opaque pointer representing a specific FireWire audio device. This is likely a handle to an internal `FWA::AudioDevice` C++ object.

4.  **Enumerations:**
    -   `FWALogLevel`: An enum defining different log levels (TRACE, DEBUG, INFO, WARN, ERROR, CRITICAL, OFF). It's explicitly typed as `int32_t` for better cross-language compatibility (e.g., with Swift).

5.  **Callback Function Pointer Types:**
    -   These define the signatures for callback functions that client applications can register to receive asynchronous notifications from the FWA engine.
    -   `typedef void (*FWALogCallback)(void* user_data, FWALogLevel level, const char* message);`:
        -   For receiving log messages generated by the FWA library. `user_data` allows the client to pass custom context.
    -   `typedef void (*FWADeviceNotificationCallback)(void* user_data, FWADeviceRef device, bool connected);`:
        -   For receiving notifications when a FireWire audio device is connected (`connected = true`) or disconnected (`connected = false`). The `device` parameter provides a handle to the affected device.

6.  **Engine Management Functions:**
    -   These functions control the lifecycle and global settings of the FWA engine.
    -   `FWAEngineRef FWAEngine_Create();`: Creates and initializes an instance of the FWA engine. Returns a handle.
    -   `void FWAEngine_Destroy(FWAEngineRef engine);`: Destroys the FWA engine instance and releases its resources.
    -   `IOReturn FWAEngine_SetLogCallback(FWAEngineRef engine, FWALogCallback callback, void* user_data);`: Registers a log callback function with the engine.
    -   `IOReturn FWAEngine_Start(FWAEngineRef engine, FWADeviceNotificationCallback notification_callback, void* user_data);`: Starts the FWA engine, initiating device discovery and enabling device notifications via the registered callback.
    -   `IOReturn FWAEngine_Stop(FWAEngineRef engine);`: Stops the FWA engine and device discovery.

7.  **Device Interaction Functions:**
    -   These functions allow clients to query information from and send commands to specific devices.
    -   **Primarily Engine-Based (using GUID):**
        -   `char* FWAEngine_GetInfoJSON(FWAEngineRef engine, uint64_t guid);`: Retrieves detailed information about a device (identified by its `guid`) as a JSON formatted string. The caller is responsible for freeing this string using `FWADevice_FreeString`.
        -   `IOReturn FWAEngine_SendCommand(FWAEngineRef engine, uint64_t guid, const uint8_t* cmd_data, size_t cmd_len, uint8_t** out_resp_data, size_t* out_resp_len);`: Sends a raw AV/C command to the specified device. The response is returned in `out_resp_data` and `out_resp_len`, and the caller must free `out_resp_data` using `FWADevice_FreeResponseBuffer`.
    -   **Device-Handle Based (Potentially older or for specific contexts):**
        -   `IOReturn FWADevice_GetGUID(FWADeviceRef device, uint64_t* out_guid);`: Gets the GUID of a device given its `FWADeviceRef`.
        -   `char* FWADevice_GetDeviceName(FWADeviceRef device);`: Gets the device name.
        -   `char* FWADevice_GetVendorName(FWADeviceRef device);`: Gets the vendor name.
    -   The comments `// --- REMOVE OR COMMENT OUT DEVICE-REF BASED VERSIONS ---` suggest a preference for the engine-based, GUID-identified functions.

8.  **Memory Management Functions for API-Allocated Data:**
    -   `void FWADevice_FreeString(char* str);`: Frees C strings allocated and returned by API functions (like `GetDeviceName`, `GetInfoJSON`).
    -   `void FWADevice_FreeResponseBuffer(uint8_t* resp_data);`: Frees the response data buffer allocated and returned by `FWAEngine_SendCommand`.

**Overall Role:**
The `fwa_capi.h` file provides a stable, C-compatible interface to the FWA library. This abstraction layer allows:
-   **Language Interoperability:** Enables applications written in languages other than C++ to use the FWA library.
-   **Simplified Usage:** Hides the complexity of the internal C++ object model behind simpler C functions and opaque handles.
-   **ABI Stability:** C APIs are generally more stable across library versions than C++ APIs (which can be affected by compiler changes, name mangling, and class layout).
Client applications use this API to manage the FWA engine, receive notifications about devices, and interact with those devices by querying information or sending commands.
